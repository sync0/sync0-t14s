;; -*- lexical-binding: t -*-

(defvar sync0-bibtex-entry-creation-entry nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-crossref-entry nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-use-extraction-page-numbers nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-extract nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-title nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-eventtitle nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-subtitle nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-title-fixed nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-eventdate nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-date nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-date-tag nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-date-fixed nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-origdate nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-author nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-author-tag nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-author-fixed nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-lastname nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-author-tag-obsidian nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-journal nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-booktitle nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-booksubtitle nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-crossref nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-chapter nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-volume nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-number nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-series nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-publisher nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-location nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-pages nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-note nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-doi nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-url nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-urldate nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-language nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-langid nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-medium nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-library nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-institution nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-attachment nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-keywords nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-type nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-type-downcase nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-key nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-creation-date nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-command nil
  "Dummy variable used for capturing new BibLaTeX entries with custom functions.")

(defvar sync0-bibtex-entry-definitions
  (list 'sync0-bibtex-entry-title
         'sync0-bibtex-entry-subtitle
         'sync0-bibtex-entry-eventtitle
         'sync0-bibtex-entry-date
         'sync0-bibtex-entry-origdate
         'sync0-bibtex-entry-eventdate
         'sync0-bibtex-entry-author
         'sync0-bibtex-entry-journal
         'sync0-bibtex-entry-booktitle
         'sync0-bibtex-entry-booksubtitle
         'sync0-bibtex-entry-crossref
         'sync0-bibtex-entry-chapter
         'sync0-bibtex-entry-volume
         'sync0-bibtex-entry-number
         'sync0-bibtex-entry-series
         'sync0-bibtex-entry-publisher
         'sync0-bibtex-entry-location
         'sync0-bibtex-entry-pages
         'sync0-bibtex-entry-note
         'sync0-bibtex-entry-doi
         'sync0-bibtex-entry-url
         'sync0-bibtex-entry-creation-date
         'sync0-bibtex-entry-language
         'sync0-bibtex-entry-language
         'sync0-bibtex-entry-medium
         'sync0-bibtex-entry-institution
         'sync0-bibtex-entry-library
         'sync0-bibtex-entry-attachment
         'sync0-bibtex-entry-keywords))

(defvar sync0-bibtex-entry-functions
  '(("Article" (lambda ()
                 (setq sync0-bibtex-entry-journal
                       (completing-read "Titre du journal : " sync0-bibtex-completion-journaltitle))
                 (setq sync0-bibtex-entry-volume
                       (read-string "Tome : "))
                 (setq sync0-bibtex-entry-number
                       (read-string "Numero : "))
                 (setq sync0-bibtex-entry-pages
                       (read-string "Pages (ex. : 90-180) : "))
                 (setq sync0-bibtex-entry-parent
                       sync0-bibtex-entry-journal)
                 (setq sync0-bibtex-entry-doi
                       (read-string "DOI : " nil nil nil t))
                 (setq sync0-bibtex-entry-url
                       (unless (string= sync0-bibtex-entry-doi "") 
                         (read-string "Url : " nil nil nil t)))))
    ("Book" (lambda ()
              (setq sync0-bibtex-entry-volume
                    (read-string "Tome : "))
              (sync0-bibtex-entry-define-publisher)
              (sync0-bibtex-entry-define-location)
              (setq sync0-bibtex-entry-series
                    (read-string "Series : "))
              (setq sync0-bibtex-entry-parent
                    sync0-bibtex-entry-series)
              (sync0-bibtex-entry-define-media)
              (sync0-bibtex-entry-define-library)
              (setq sync0-bibtex-entry-url
                    (read-string "Url : " nil nil nil t))))
    ("Collection" (lambda ()
                    (setq sync0-bibtex-entry-volume
                          (read-string "Tome : "))
                    (sync0-bibtex-entry-define-publisher)
                    (sync0-bibtex-entry-define-location)
                    (setq sync0-bibtex-entry-series
                          (read-string "Series : "))
                    (setq sync0-bibtex-entry-parent
                          sync0-bibtex-entry-series)
                    (sync0-bibtex-entry-define-media)
                    (sync0-bibtex-entry-define-library)
                    (setq sync0-bibtex-entry-url
                          (read-string "Url : " nil nil nil t))))
    ("InBook" (lambda ()
                (setq sync0-bibtex-entry-extract
                      (yes-or-no-p "Extract  PDF from existing entry?"))
                (setq sync0-bibtex-entry-use-extraction-page-numbers
                      (when sync0-bibtex-entry-extract
                        (yes-or-no-p "Use page numbers from extraction?")))
                (setq sync0-bibtex-entry-pages
                      (read-string "Pages (ex. : 90-180) : "))
                (sync0-bibtex-entry-define-booktitle)
                (setq sync0-bibtex-entry-chapter
                      (read-string "Chapter : "))
                (setq sync0-bibtex-entry-parent
                      (if (sync0-null-p sync0-bibtex-entry-booksubtitle)
                          sync0-bibtex-entry-booktitle
                        (concat sync0-bibtex-entry-booktitle " : " sync0-bibtex-entry-booksubtitle)))
                (unless sync0-bibtex-entry-crossref 
                  (progn
                    (setq sync0-bibtex-entry-series
                          (read-string "Series : "))
                    (sync0-bibtex-entry-define-media)
                    (sync0-bibtex-entry-define-library)
                    (sync0-bibtex-entry-define-publisher)
                    (sync0-bibtex-entry-define-location)))))
    ("InCollection" (lambda ()
                      (setq sync0-bibtex-entry-extract
                            (yes-or-no-p "Extract  PDF from existing entry?"))
                      (setq sync0-bibtex-entry-use-extraction-page-numbers
                            (when sync0-bibtex-entry-extract
                              (yes-or-no-p "Use page numbers from extraction?")))
                      (setq sync0-bibtex-entry-pages
                            (read-string "Pages (ex. : 90-180) : "))
                      (sync0-bibtex-entry-define-booktitle)
                      (setq sync0-bibtex-entry-chapter
                            (read-string "Chapter : "))
                      (setq sync0-bibtex-entry-parent
                            (if (sync0-null-p sync0-bibtex-entry-booksubtitle)
                                sync0-bibtex-entry-booktitle
                              (concat sync0-bibtex-entry-booktitle " : " sync0-bibtex-entry-booksubtitle)))
                      (unless sync0-bibtex-entry-crossref 
                        (progn
                          (setq sync0-bibtex-entry-series
                                (read-string "Series : "))
                          (sync0-bibtex-entry-define-media)
                          (sync0-bibtex-entry-define-library)
                          (sync0-bibtex-entry-define-publisher)
                          (sync0-bibtex-entry-define-location)))))
    ("InProceedings" (lambda ()
                       (setq sync0-bibtex-entry-extract
                             (yes-or-no-p "Extract  PDF from existing entry?"))
                       (setq sync0-bibtex-entry-use-extraction-page-numbers
                             (when sync0-bibtex-entry-extract
                               (yes-or-no-p "Use page numbers from extraction?")))
                       (setq sync0-bibtex-entry-pages
                             (read-string "Pages (ex. : 90-180) : "))
                       (sync0-bibtex-entry-define-booktitle)
                       (setq sync0-bibtex-entry-chapter
                             (read-string "Chapter : "))
                       (setq sync0-bibtex-entry-parent
                             (if (sync0-null-p sync0-bibtex-entry-booksubtitle)
                                 sync0-bibtex-entry-booktitle
                               (concat sync0-bibtex-entry-booktitle " : " sync0-bibtex-entry-booksubtitle)))
                       (unless sync0-bibtex-entry-crossref 
                         (progn
                           (setq sync0-bibtex-entry-eventtitle
                                 (read-string "Event title : "))
                           (setq sync0-bibtex-entry-eventdate
                                 (read-string "Event date (ex. 1990-12-28) : "))
                           (setq sync0-bibtex-entry-series
                                 (read-string "Series : "))
                           (sync0-bibtex-entry-define-media)
                           (sync0-bibtex-entry-define-library)
                           (sync0-bibtex-entry-define-publisher)
                           (sync0-bibtex-entry-define-location)))))
    ("Manual" (lambda ()
                (setq sync0-bibtex-entry-institution
                      (read-string "Institution : "))
                (setq sync0-bibtex-entry-number
                      (read-string "Numero : "))
                (setq sync0-bibtex-entry-volume
                      (read-string "Tome : "))
                (sync0-bibtex-entry-define-publisher)
                (sync0-bibtex-entry-define-location)
                (setq sync0-bibtex-entry-series
                      (read-string "Series : "))
                (setq sync0-bibtex-entry-parent
                      sync0-bibtex-entry-series)
                (sync0-bibtex-entry-define-media)
                (sync0-bibtex-entry-define-library)
                (setq sync0-bibtex-entry-url
                      (read-string "Url : " nil nil nil t))
                (sync0-bibtex-entry-define-note)))
    ("Online" (lambda ()
                (setq sync0-bibtex-entry-institution
                      (read-string "Institution : "))
                (sync0-bibtex-entry-define-publisher)
                (setq sync0-bibtex-entry-series
                      (read-string "Series : "))
                (setq sync0-bibtex-entry-parent
                      sync0-bibtex-entry-series)
                (sync0-bibtex-entry-define-media)
                (sync0-bibtex-entry-define-library)
                (setq sync0-bibtex-entry-url
                      (read-string "Url : " nil nil nil t))
                (sync0-bibtex-entry-define-note)))
    ("Report" (lambda ()
                (setq sync0-bibtex-entry-institution
                      (read-string "Institution : "))
                (setq sync0-bibtex-entry-number
                      (read-string "Numero : "))
                (setq sync0-bibtex-entry-volume
                      (read-string "Tome : "))
                (setq sync0-bibtex-entry-series
                      (read-string "Series : "))
                (setq sync0-bibtex-entry-parent
                      sync0-bibtex-entry-series)
                (sync0-bibtex-entry-define-publisher)
                (sync0-bibtex-entry-define-location)
                (sync0-bibtex-entry-define-media)
                (sync0-bibtex-entry-define-library)
                (setq sync0-bibtex-entry-url
                      (read-string "Url : " nil nil nil t))
                (sync0-bibtex-entry-define-note)))
    ("Unpublished" (lambda ()
                     (setq sync0-bibtex-entry-number
                           (read-string "Numero : "))
                     (setq sync0-bibtex-entry-institution
                           (read-string "Institution : "))
                     (setq sync0-bibtex-entry-series
                           (read-string "Series : "))
                     (setq sync0-bibtex-entry-parent
                           sync0-bibtex-entry-series)
                     (sync0-bibtex-entry-define-publisher)
                     (sync0-bibtex-entry-define-location)
                     (sync0-bibtex-entry-define-media)
                     (sync0-bibtex-entry-define-library)
                     (setq sync0-bibtex-entry-url
                           (read-string "Url : " nil nil nil t))
                (sync0-bibtex-entry-define-note)))
    ("Thesis" (lambda ()
                (setq sync0-bibtex-entry-number
                      (read-string "Numero : "))
                (setq sync0-bibtex-entry-institution
                      (read-string "Institution : "))
                (sync0-bibtex-entry-define-publisher)
                (sync0-bibtex-entry-define-location)
                (sync0-bibtex-entry-define-media)
                (sync0-bibtex-entry-define-library)
                (setq sync0-bibtex-entry-url
                      (read-string "Url : " nil nil nil t))
                (sync0-bibtex-entry-define-note)))
    ("Proceedings" (lambda ()
                     (setq sync0-bibtex-entry-volume
                           (read-string "Tome : "))
                     (sync0-bibtex-entry-define-publisher)
                     (sync0-bibtex-entry-define-location)
                     (setq sync0-bibtex-entry-series
                           (read-string "Series : "))
                     (setq sync0-bibtex-entry-parent
                           sync0-bibtex-entry-series)
                     (sync0-bibtex-entry-define-media)
                     (sync0-bibtex-entry-define-library)
                     (setq sync0-bibtex-entry-eventtitle
                           (read-string "Event title : "))
                     (setq sync0-bibtex-entry-eventdate
                           (read-string "Event date (ex. 1990-12-28) : "))
                     (setq sync0-bibtex-entry-url
                           (read-string "Url : " nil nil nil t))))))

(defun sync0-bibtex-entry-define-note (&optional bibkey)
  "Define the note for new BibLaTeX entry. For the optional
   argument to work correctly, the variable
   sync0-bibtex-entry-creation-entry must have been defined
   beforehand using the function bibtex-completion-get-entry"
  (setq sync0-bibtex-entry-note
        (if bibkey
            (bibtex-completion-get-value "note" sync0-bibtex-entry-creation-entry)
          (completing-read "Choose language : "
                           sync0-bibtex-completion-note))))

(defun sync0-bibtex-entry-define-language (&optional bibkey)
  "Define the language for new BibLaTeX entry. For the optional
   argument to work correctly, the variable
   sync0-bibtex-entry-creation-entry must have been defined
   beforehand using the function bibtex-completion-get-entry"
  (setq sync0-bibtex-entry-language
        (if bibkey
            (bibtex-completion-get-value "language" sync0-bibtex-entry-creation-entry)
          (completing-read "Choose language : "
                           sync0-bibtex-completion-language nil nil sync0-bibtex-entry-initial-language))))

(defun sync0-bibtex-entry-define-keywords ()
  "Define the keywords for new BibLaTeX entry."
  (setq sync0-bibtex-entry-keywords
        (concat sync0-bibtex-entry-type-downcase ", "
                (unless (sync0-null-p sync0-bibtex-entry-date)
                  (concat sync0-bibtex-entry-date ", "))
                (unless (sync0-null-p sync0-bibtex-entry-origdate)
                  (concat sync0-bibtex-entry-origdate ", "))
                (unless (sync0-null-p sync0-bibtex-entry-crossref)
                  (concat sync0-bibtex-entry-crossref ", "))
                (unless (sync0-null-p sync0-bibtex-entry-author-tag)
                  sync0-bibtex-entry-author-tag))))

(defun sync0-bibtex-entry-define-booktitle ()
  "Define the booktitle for new BibLaTeX entry."
  (setq sync0-bibtex-entry-booktitle
          (if sync0-bibtex-entry-crossref 
              (bibtex-completion-get-value "title" sync0-bibtex-entry-crossref-entry)
            (read-string "Book title : ")))
  (setq sync0-bibtex-entry-subbooktitle
        (if sync0-bibtex-entry-crossref 
            (bibtex-completion-get-value "subtitle" sync0-bibtex-entry-crossref-entry)
          (read-string "Book subtitle : "))))

(defun sync0-bibtex-entry-define-library ()
  "Define the library for new BibLaTeX entry."
  (setq sync0-bibtex-entry-library
        (completing-read "Choose location to trace back: "
                         sync0-bibtex-completion-library nil nil nil)))

(defun sync0-bibtex-entry-define-location ()
  "Define the media for new BibLaTeX entry."
  (setq sync0-bibtex-entry-location
        (completing-read "Location : " sync0-bibtex-completion-location)))

(defun sync0-bibtex-entry-define-publisher ()
  "Define the publisher for new BibLaTeX entry."
  (setq sync0-bibtex-entry-publisher
        (completing-read "Maison d'edition : " sync0-bibtex-completion-publisher)))

(defun sync0-bibtex-entry-define-media ()
  "Define the media for new BibLaTeX entry."
  (setq sync0-bibtex-entry-medium
        (string-trim
         (prin1-to-string
          (completing-read-multiple "Quel support ?"
                                    sync0-bibtex-completion-medium)) "(\"" "\")")))

(defun sync0-bibtex-entry-define-author (&optional bibkey)
  "Define the author for new BibLaTeX entry. For the optional
   argument to work correctly, the variable
   sync0-bibtex-entry-creation-entry must have been defined
   beforehand using the function bibtex-completion-get-entry"
  (setq sync0-bibtex-entry-author
        (if bibkey 
            (if (or (string= sync0-bibtex-entry-type "Collection")
                    (string= sync0-bibtex-entry-type "Proceedings"))
                (bibtex-completion-get-value "editor" sync0-bibtex-entry-creation-entry)
              (bibtex-completion-get-value "author" sync0-bibtex-entry-creation-entry))
          (completing-read "Auteur : " sync0-bibtex-completion-author
                           nil nil sync0-bibtex-entry-initial-author)))
  (setq sync0-bibtex-entry-author-fixed
        (unless (sync0-null-p sync0-bibtex-entry-author)
          (cond ((string-match " and " sync0-bibtex-entry-author)
                 ;; create a list with parts 
                 (let* ((author-list  (split-string sync0-bibtex-entry-author " and "))
                        (names (let (x)
                                 (dolist  (element author-list x)
                                   (setq x (concat x element "\", \""))))))
                   (concat "\"" (substring names 0 -2))))
                ;; check when author is an organization
                ((string-match "^{" sync0-bibtex-entry-author)
                 (concat "\"" (substring sync0-bibtex-entry-author 1 -1) "\""))
                ;; other cases
                (t (concat "\"" sync0-bibtex-entry-author "\"")))))
  (setq sync0-bibtex-entry-lastname
        (unless (sync0-null-p sync0-bibtex-entry-author)
          (cond ((string-match " and " sync0-bibtex-entry-author)
                 ;; create a list with parts 
                 (let* ((author-list  (split-string sync0-bibtex-entry-author " and "))
                        (last-names (let (x)
                                      (dolist  (element author-list x)
                                        (setq x (concat x
                                                        (progn
                                                          (string-match "\\([[:print:]]+\\),"   element)
                                                          (match-string 1 element))
                                                        ", "))))))
                   (substring last-names 0 -2)))
                ((string-match "^{" sync0-bibtex-entry-author)
                 (string-match "{\\([[:print:]]+\\)}" sync0-bibtex-entry-author)
                 (match-string 1 sync0-bibtex-entry-author))
                (t (nth 0 (split-string sync0-bibtex-entry-author ", "))))))
  (setq sync0-bibtex-entry-author-tag-obsidian
        (unless (sync0-null-p sync0-bibtex-entry-author)
          (cond ((string-match " and " sync0-bibtex-entry-author)
                 (let* ((no-comma (replace-regexp-in-string ", " "_" (downcase sync0-bibtex-entry-author)))
                        (no-space (replace-regexp-in-string "[[:space:]]+" "-" no-comma))
                        (replace-regexp-in-string "-and-" ", author/" no-space))))
                ((string-match "^{" sync0-bibtex-entry-author)
                 (string-match "{\\([[:print:]]+\\)}" sync0-bibtex-entry-author)
                 (downcase (match-string 1 sync0-bibtex-entry-author)))
                (t (let ((raw (replace-regexp-in-string ", " "_" sync0-bibtex-entry-author)))
                     (downcase (replace-regexp-in-string " " "-" raw)))))))
  (setq sync0-bibtex-entry-author-tag
        (unless (sync0-null-p sync0-bibtex-entry-author)
          (cond ((string-match " and " sync0-bibtex-entry-author)
                 (let* ((no-comma (replace-regexp-in-string ", " "_" (downcase sync0-bibtex-entry-author)))
                        (no-space (replace-regexp-in-string "[[:space:]]+" "-" no-comma))
                        (replace-regexp-in-string "-and-" ", " no-space))))
                ((string-match "^{" sync0-bibtex-entry-author)
                 (string-match "{\\([[:print:]]+\\)}" sync0-bibtex-entry-author)
                 (downcase (match-string 1 sync0-bibtex-entry-author)))
                (t (let ((raw (replace-regexp-in-string ", " "_" sync0-bibtex-entry-author)))
                     (downcase (replace-regexp-in-string " " "-" raw))))))))

(defun sync0-bibtex-entry-define-title (&optional bibkey)
  "Define the title for new BibLaTeX entry. For the optional
   argument to work correctly, the variable
   sync0-bibtex-entry-creation-entry must have been defined
   beforehand using the function bibtex-completion-get-entry"
  (setq sync0-bibtex-entry-title
        (if bibkey
            (bibtex-completion-get-value "title" sync0-bibtex-entry-creation-entry)
          (let* ((candidates (bibtex-completion-candidates))
                 (selection (ivy-read "Input title : "
                                      candidates
                                      :caller 'ivy-bibtex
                                      :require-match nil
                                      :history 'ivy-bibtex-history)))
            (if (string-match-p "[0-9]\\{14\\}$" selection)
                (cdr (assoc "title" (cdr (assoc selection candidates))))
              selection))))
  (setq sync0-bibtex-entry-subtitle
        (if bibkey
            (bibtex-completion-get-value "subtitle" sync0-bibtex-entry-creation-entry)
          (read-string "Sous-titre du texte : " nil nil nil t)))
  (setq sync0-bibtex-entry-title-fixed
        (if (sync0-null-p sync0-bibtex-entry-subtitle)
            sync0-bibtex-entry-title
          (concat sync0-bibtex-entry-title " : " sync0-bibtex-entry-subtitle))))

  ;; (setq sync0-bibtex-variables-list-two
  ;;   '(("booktitle" . (sync0-bibtex-entry-booktitle sync0-bibtex-completion-booktitle "~/.emacs.d/sync0-vars/bibtex-booktitles.txt"))
  ;;     ("publisher" . (sync0-bibtex-entry-booktitle sync0-bibtex-completion-publisher "~/.emacs.d/sync0-vars/bibtex-publishers.txt"))
  ;;     ("journaltitle" . (sync0-bibtex-entry-booktitle sync0-bibtex-completion-journaltitle "~/.emacs.d/sync0-vars/bibtex-journals.txt"))
  ;;     ("location" (sync0-bibtex-entry-booktitle sync0-bibtex-completion-location "~/.emacs.d/sync0-vars/bibtex-locations.txt"))
  ;;     ("author" (sync0-bibtex-entry-booktitle sync0-bibtex-completion-author "~/.emacs.d/sync0-vars/bibtex-authors.txt"))
  ;;     ("parent" (sync0-bibtex-entry-booktitle sync0-bibtex-completion-library "~/.emacs.d/sync0-vars/bibtex-trace.txt"))
  ;;     ("media" (sync0-bibtex-entry-booktitle sync0-bibtex-completion-medium "~/.emacs.d/sync0-vars/bibtex-media.txt"))
  ;;     ("institution" (sync0-bibtex-entry-booktitle sync0-bibtex-completion-institution "~/.emacs.d/sync0-vars/bibtex-institutions.txt"))
  ;;     ("language" (sync0-bibtex-entry-booktitle sync0-bibtex-completion-language  "~/.emacs.d/sync0-vars/languages.txt"))))

  ;; (setq sync0-bibtex-variables-list-two
  ;;   '((sync0-bibtex-entry-booktitle sync0-bibtex-completion-booktitle "~/.emacs.d/sync0-vars/bibtex-booktitles.txt")
  ;;     (sync0-bibtex-entry-publisher sync0-bibtex-completion-publisher "~/.emacs.d/sync0-vars/bibtex-publishers.txt")
  ;;     (sync0-bibtex-entry-journal sync0-bibtex-completion-journaltitle "~/.emacs.d/sync0-vars/bibtex-journals.txt")
  ;;     (sync0-bibtex-entry-location sync0-bibtex-completion-location "~/.emacs.d/sync0-vars/bibtex-locations.txt")
  ;;     (sync0-bibtex-entry-author sync0-bibtex-completion-author "~/.emacs.d/sync0-vars/bibtex-authors.txt")
  ;;     (sync0-bibtex-entry-library sync0-bibtex-completion-library "~/.emacs.d/sync0-vars/bibtex-trace.txt")
  ;;     (sync0-bibtex-entry-medium sync0-bibtex-completion-medium "~/.emacs.d/sync0-vars/bibtex-media.txt")
  ;;     (sync0-bibtex-entry-institution sync0-bibtex-completion-institution "~/.emacs.d/sync0-vars/bibtex-institutions.txt")
  ;;     (sync0-bibtex-entry-language sync0-bibtex-completion-language  "~/.emacs.d/sync0-vars/languages.txt")))

  (setq sync0-bibtex-variables-list
    '(("booktitle" sync0-bibtex-entry-booktitle sync0-bibtex-completion-booktitle "~/.emacs.d/sync0-vars/bibtex-completion-booktitle.txt")
      ("publisher" sync0-bibtex-entry-publisher sync0-bibtex-completion-publisher "~/.emacs.d/sync0-vars/bibtex-completion-publisher.txt")
      ("journaltitle" sync0-bibtex-entry-journal sync0-bibtex-completion-journaltitle "~/.emacs.d/sync0-vars/bibtex-completion-journaltitle.txt")
      ("location" sync0-bibtex-entry-location sync0-bibtex-completion-location "~/.emacs.d/sync0-vars/bibtex-completion-location.txt")
      ("note" sync0-bibtex-entry-note sync0-bibtex-completion-note "~/.emacs.d/sync0-vars/bibtex-completion-note.txt")
      ("author" sync0-bibtex-entry-author sync0-bibtex-completion-author "~/.emacs.d/sync0-vars/bibtex-completion-author.txt")
      ("library" sync0-bibtex-entry-library sync0-bibtex-completion-library "~/.emacs.d/sync0-vars/bibtex-completion-library.txt")
      ("medium" sync0-bibtex-entry-medium sync0-bibtex-completion-medium "~/.emacs.d/sync0-vars/bibtex-completion-medium.txt")
      ("institution" sync0-bibtex-entry-institution sync0-bibtex-completion-institution "~/.emacs.d/sync0-vars/bibtex-completion-institution.txt")
      ("language" sync0-bibtex-entry-language sync0-bibtex-completion-language  "~/.emacs.d/sync0-vars/bibtex-completion-language.txt")))

  ;; (setq foo
  ;;   '((sync0-bibtex-entry-booktitle sync0-bibtex-completion-booktitle "~/.emacs.d/sync0-vars/bibtex-booktitles.txt")
  ;;     (sync0-bibtex-entry-publisher sync0-bibtex-completion-publisher "~/.emacs.d/sync0-vars/bibtex-publishers.txt")))

  ;;     (setq sync0-bibtex-entry-publisher "Crazy University Press")
  ;;     (setq sync0-bibtex-entry-publisher "Instituto Democracia y Mercado")
  ;;     (setq sync0-bibtex-entry-publisher "Siglo Veintiuno")
  ;;     (setq sync0-bibtex-entry-booktitle "The Crazy Book")

;; (defun sync0-bibtex-update-vars (seqlists)
;;   "Update variables used for completion based on the information
;;    provided by the new entry."
;;   (mapc #'(lambda (x) (member (eval (car  x)) (eval (cadr x)))) seqlists))

;; (defun sync0-bibtex-update-vars (seqlists)
;;   "Update variables used for completion based on the information
;;    provided by the new entry."
;;   (dolist (element seqlists)
;;     (unless (member (eval (car element))  (eval (cadr element)))
;;       (push (car element) (cadr element))
;;       (append-to-file (concat (eval (car element)) "\n") nil (caddr element)))))

;; (defun sync0-bibtex-update-vars (seqlists)
;;   "Update variables used for completion based on the information
;;    provided by the new entry."
;;   (dolist (element seqlists)
;;     (unless (member (eval (caadr element))  (eval (cadadr element)))
;;       (push (caadr element) (cadadr element))
;;       (append-to-file (concat (eval (caadr element)) "\n") nil (car (cddadr element))))))

(defun sync0-bibtex-update-vars (seqlists)
  "Update variables used for completion based on the information
   provided by the new entry."
  (dolist (element seqlists)
    (unless (member (eval (cadr element))  (eval (caddr element)))
      (push (cadr element) (caddr element))
      (append-to-file (concat (eval (cadr element)) "\n") nil (cadddr element)))))

(defun sync0-bibtex-update-completion-files (seqlists)
  (interactive)
  (dolist (element seqlists)
    (let ((current-elements)
          (final-list)
          (bib-elements (delete-duplicates
                         (mapcar #'(lambda (x) (cdr (assoc (car element) x)))
                                  (bibtex-completion-candidates)))))
      (with-temp-buffer
        (insert-file-contents (cadddr element))
        (goto-char (point-min))
        ;; (keep-lines "contexts" (point-min) (point-max)) 
        (while (re-search-forward "^\\([[:print:]]+\\)\n" (point-max) t)
          (push  (match-string 1) current-elements)))
      (with-temp-file (cadddr element)
        (setq final-list (delete-dups (append current-elements bib-elements)))
        (sync0-insert-elements-of-list final-list)))))

;; (defun sync0-bibtex-update-vars ()
;;   "Define the title for new BibLaTeX entry."
;;   (unless (member sync0-bibtex-entry-author sync0-bibtex-completion-author)
;;     (add-to-list 'sync0-bibtex-completion-author sync0-bibtex-entry-author)
;;   (append-to-file sync0-bibtex-entry-author nil "~/.emacs.d/sync0-vars/bibtex-authors.txt"))
;;   (unless (member sync0-bibtex-entry-booktitle sync0-bibtex-completion-booktitle)
;;     (add-to-list 'sync0-bibtex-completion-booktitle sync0-bibtex-entry-booktitle)
;;     (with-temp-file "~/.emacs.d/sync0-vars/bibtex-booktitles.txt"
;;       (sync0-insert-elements-of-list sync0-bibtex-completion-booktitle)))
;;   (unless (member sync0-bibtex-entry-location sync0-bibtex-completion-location)
;;     (add-to-list 'sync0-bibtex-completion-location sync0-bibtex-entry-location)
;;     (with-temp-file "~/.emacs.d/sync0-vars/bibtex-locations.txt"
;;       (sync0-insert-elements-of-list sync0-bibtex-completion-location)))
;;   (unless (member sync0-bibtex-entry-library sync0-bibtex-completion-library)
;;     (add-to-list 'sync0-bibtex-completion-library sync0-bibtex-entry-library)
;;     (with-temp-file "~/.emacs.d/sync0-vars/bibtex-traces.txt"
;;       (sync0-insert-elements-of-list sync0-bibtex-completion-library)))
;;   (unless (member sync0-bibtex-entry-medium sync0-bibtex-completion-medium)
;;     (add-to-list 'sync0-bibtex-completion-medium sync0-bibtex-entry-medium)
;;     (with-temp-file "~/.emacs.d/sync0-vars/bibtex-media.txt"
;;       (sync0-insert-elements-of-list sync0-bibtex-completion-medium)))
;;   (unless (member sync0-bibtex-entry-publisher sync0-bibtex-completion-publisher)
;;     (add-to-list 'sync0-bibtex-completion-publisher sync0-bibtex-entry-location)
;;     (with-temp-file "~/.emacs.d/sync0-vars/bibtex-publishers.txt"
;;       (sync0-insert-elements-of-list sync0-bibtex-completion-publisher)))
;;   (unless (member sync0-bibtex-entry-institution sync0-bibtex-completion-institution)
;;     (add-to-list 'sync0-bibtex-completion-institution sync0-bibtex-entry-institution)
;;     (with-temp-file "~/.emacs.d/sync0-vars/bibtex-institutions.txt"
;;       (sync0-insert-elements-of-list sync0-bibtex-completion-institution)))
;;   (unless (member sync0-bibtex-entry-journal sync0-bibtex-completion-journaltitle)
;;     (add-to-list 'sync0-bibtex-completion-journaltitle sync0-bibtex-entry-journal)
;;     (with-temp-file "~/.emacs.d/sync0-vars/bibtex-journals.txt"
;;       (sync0-insert-elements-of-list sync0-bibtex-completion-journaltitle))))

(defun sync0-bibtex-entry-append-to-bibliography (bibkey)
  "Append new BibLaTeX entry to default bibliography file.
   Beware, this function only constructs and appends the entry
   to the bib file; the values of the entry must have been defined
   elsewhere. For the sake of speed, this function does not
   perform any sanity checks on duplicate entries, and thus a
   unique correct entry is assumed to be supplied as mandatory
   argument bibkey."
  (let* ((definitions (mapcar #'eval sync0-bibtex-entry-definitions))
         (bibtex-fields (if (or (string= sync0-bibtex-entry-type "Collection")
                                (string= sync0-bibtex-entry-type "Proceedings"))
                            (cl-substitute "editor" "author" sync0-bibtex-fields :test #'string=)
                          sync0-bibtex-fields))
         (fields (mapcar* #'(lambda (x y) (list x y)) bibtex-fields definitions))
         ;; define the bibtex entries
         (entries
          (let (x)
            (dolist (element fields x) 
              (unless (sync0-null-p (cadr element))
                (setq x (concat x (car element) " = {" (cadr element) "},\n"))))))
         (bibtex-entry (concat "\n@" sync0-bibtex-entry-type "{" bibkey ",\n" entries "}\n")))
    (if (string= sync0-default-bibliography (buffer-file-name))
        (progn
          (goto-char (point-max))
          (insert bibtex-entry))
      (append-to-file bibtex-entry nil sync0-default-bibliography))))

(defun sync0-bibtex-entry-define-date (&optional bibkey)
  "Define the dates for new BibLaTeX entry."
  (setq sync0-bibtex-entry-creation-date
        (format-time-string "%Y-%m-%d")) 
  (setq sync0-bibtex-entry-date
        (if bibkey 
            (bibtex-completion-get-value "date" sync0-bibtex-entry-creation-entry)
          (read-string "Date (ex. 1890-18-12) : " sync0-bibtex-entry-initial-date)))
  (setq sync0-bibtex-entry-origdate
        (if bibkey 
            (bibtex-completion-get-value "origdate" sync0-bibtex-entry-creation-entry)
          (read-string "Origdate (ex. 1890-18-12) : " sync0-bibtex-entry-initial-origdate)))
  (setq sync0-bibtex-entry-date-tag
        (replace-regexp-in-string "-" "/" sync0-bibtex-entry-date))
  (setq sync0-bibtex-entry-date-fixed
        (if (or (sync0-null-p sync0-bibtex-entry-origdate)
                (string= sync0-bibtex-entry-date sync0-bibtex-entry-origdate))
            (concat "(" sync0-bibtex-entry-date ")")
          (concat "(" sync0-bibtex-entry-origdate ") (" sync0-bibtex-entry-date ")"))))

(defun sync0-bibtex-entry-create-obsidian-note-from-entry (bibkey)
  "Define the dates for new BibLaTeX entry."
  (let ((obsidian-file (concat sync0-obsidian-directory bibkey ".md")) 
        (obsidian-entry (concat "---\n"
                                "zettel_type: reference\n"
                                "id: " bibkey "\n"
                                "citekey: " bibkey "\n"
                                "created: " sync0-bibtex-entry-creation-date "\n"
                                "biblatex_type: " sync0-bibtex-entry-type-downcase  "\n"
                                "title: \"" sync0-bibtex-entry-title "\"\n"
                                (unless (sync0-null-p sync0-bibtex-entry-subtitle)
                                  (concat "subtitle: \"" sync0-bibtex-entry-subtitle "\"\n"))
                                (unless (sync0-null-p sync0-bibtex-entry-author)
                                  (concat "author: [" sync0-bibtex-entry-author-fixed "]\n"))
                                (unless (sync0-null-p sync0-bibtex-entry-crossref)
                                  (concat "crossref: " sync0-bibtex-entry-crossref "\n"))
                                (unless (sync0-null-p sync0-bibtex-entry-parent)
                                  (concat "parent: \"" sync0-bibtex-entry-parent "\"\n"))
                                (if (sync0-null-p sync0-bibtex-entry-subtitle)
                                    (concat "aliases: [\"" (unless (sync0-null-p sync0-bibtex-entry-author) (concat sync0-bibtex-entry-lastname " ")) sync0-bibtex-entry-date-fixed " " sync0-bibtex-entry-title-fixed "\"]\n")
                                  (concat "aliases: [\"" (unless (sync0-null-p sync0-bibtex-entry-author) (concat sync0-bibtex-entry-lastname " ")) sync0-bibtex-entry-date-fixed " " sync0-bibtex-entry-title-fixed "\", "
                                          "\"" (unless (sync0-null-p sync0-bibtex-entry-author) sync0-bibtex-entry-lastname) " " sync0-bibtex-entry-date-fixed  " " sync0-bibtex-entry-title "\"]\n"))
                                (unless (sync0-null-p sync0-bibtex-entry-url)
                                  (concat "url: \"" sync0-bibtex-entry-url "\"\n"))
                                (unless (sync0-null-p sync0-bibtex-entry-origdate)
                                  (concat "origdate: " sync0-bibtex-entry-origdate "\n"))
                                "date: " sync0-bibtex-entry-date "\n"
                                (unless (sync0-null-p sync0-bibtex-entry-medium)
                                  (concat "medium: [\"" sync0-bibtex-entry-medium "\"]\n"))
                                "language: " sync0-bibtex-entry-language "\n"
                                (unless (sync0-null-p sync0-bibtex-entry-library)
                                  (concat "library: [\"" sync0-bibtex-entry-library "\"]\n"))
                                "tags: [reference/" sync0-bibtex-entry-type-downcase ", bibkey/" bibkey ", date/" sync0-bibtex-entry-date-tag (unless (sync0-null-p sync0-bibtex-entry-author) (concat ", author/" sync0-bibtex-entry-author-tag-obsidian)) ", language/" sync0-bibtex-entry-language"]\n"
                                "---\n" 
                                "# " (unless (sync0-null-p sync0-bibtex-entry-author) (concat sync0-bibtex-entry-lastname " ")) sync0-bibtex-entry-date-fixed " " sync0-bibtex-entry-title-fixed "\n\n"     
                                "## Description\n\n" 
                                "## Progrès de la lecture\n\n" 
                                "## Annotations\n\n")))
    (if (file-exists-p obsidian-file)
        (message "Error: %s.md file already present in Obsidian vault." bibkey)
      (with-temp-buffer 
        (insert obsidian-entry)
        (write-file obsidian-file)))))

(defun sync0-bibtex-entry-extract-pdf (filename &optional beg end)
  "Extract pdf from crossref defined by
           sync0-bibtex-entry-crossref. Before activating,
           sync0-bibtex-entry-extract must be set to t. Filename
           is not automatically calculated because this function
           is not standalone; it is intended to be part of
           pipes. Therefore, filename is the only mandatory argument."
  (when (and  sync0-bibtex-entry-crossref
              sync0-bibtex-entry-extract)
    (let* ((beg (unless beg
                  (read-string "First page for extraction: ")))
           (end (unless end
                  (read-string "Last page for extraction: ")))
           (origfile (car (bibtex-completion-find-pdf sync0-bibtex-entry-crossref)))
           (command (unless (null origfile)
                      (concat
                       "gs -sDEVICE=pdfwrite -dNOPAUSE -dBATCH -dSAFER -dFirstPage="
                       beg
                       " -dLastPage="
                       end
                       " -sOutputFile="
                       sync0-pdfs-folder filename ".pdf " origfile))))
      (shell-command command))))

(defun sync0-bibtex-completion-choose-key ()
  "Choose key with completion."
  (let* ((candidates (bibtex-completion-candidates))
         (selection (ivy-read "Crossref : "
                              candidates
                              :caller 'ivy-bibtex
                              :history 'ivy-bibtex-history)))
    (cdr (assoc "=key=" (cdr (assoc selection candidates))))))

(defun sync0-bibtex-define-entry (&optional quick)
  "Create new BibLaTeX entry in the default bibliography. When
   optional quick is non-nil, only capture the minimal fields
   required to create a new entry."
  (interactive)
  ;; Before calculating any values, reset all values in my
  ;; master list of variable (set them to nil).
  (mapcar #'(lambda (a) (set a nil)) sync0-bibtex-entry-definitions)
  (let* ((type (completing-read "Choose Bibtex entry type: " sync0-bibtex-entry-types))
         (derivation (when (or (string= type "InCollection")
                               (string= type "InBook")
                               (string= type "InProceedings"))
                       (yes-or-no-p "Derive entry?"))))
    (setq sync0-bibtex-entry-crossref 
          (when derivation
            (sync0-bibtex-completion-choose-key)))
    (setq sync0-bibtex-entry-crossref-entry
          (when sync0-bibtex-entry-crossref
            (bibtex-completion-get-entry sync0-bibtex-entry-crossref)))
    (if derivation
        (setq sync0-bibtex-entry-initial-date
              (bibtex-completion-get-value "date" sync0-bibtex-entry-crossref-entry)
              sync0-bibtex-entry-initial-origdate
              (bibtex-completion-get-value "origdate" sync0-bibtex-entry-crossref-entry)
              sync0-bibtex-entry-initial-author
              (if (or (string= type "Collection")
                      (string= type "InCollection")
                      (string= type "Proceedings")
                      (string= type "InProceedings"))
                  (bibtex-completion-get-value "editor" sync0-bibtex-entry-crossref-entry)
                (bibtex-completion-get-value "author" sync0-bibtex-entry-crossref-entry))
              sync0-bibtex-entry-initial-language
              (bibtex-completion-get-value "language" sync0-bibtex-entry-crossref-entry))
      (setq sync0-bibtex-entry-initial-date nil
            sync0-bibtex-entry-initial-origdate nil
            sync0-bibtex-entry-initial-author nil
            sync0-bibtex-entry-initial-language nil))
    ;; General settings
    (setq sync0-bibtex-entry-type type)
    (setq sync0-bibtex-entry-type-downcase
          (downcase type))
    (setq sync0-bibtex-entry-key
          (format-time-string "%Y%m%d%H%M%S"))
    (setq sync0-bibtex-entry-attachment
          (unless (string= sync0-bibtex-entry-type "Online")
            (concat "/home/sync0/Documents/pdfs/" sync0-bibtex-entry-key ".pdf")))
    (sync0-bibtex-entry-define-author)
    (sync0-bibtex-entry-define-title)
    (sync0-bibtex-entry-define-date)
    (sync0-bibtex-entry-define-language)
    (sync0-bibtex-entry-define-keywords)
    ;; Type-specific settings
    (unless quick
      (funcall (cadr (assoc type sync0-bibtex-entry-functions)))
      ;; delete unused entries
      (if sync0-bibtex-entry-use-extraction-page-numbers
          (let ((beg (progn
                       (string-match "\\([[:digit:]]+\\)-[[:digit:]]+"  sync0-bibtex-entry-pages)
                       (match-string 1 sync0-bibtex-entry-pages)))
                (end (progn
                       (string-match "[[:digit:]]+-\\([[:digit:]]+\\)" sync0-bibtex-entry-pages)
                       (match-string 1 sync0-bibtex-entry-pages))))
            (sync0-bibtex-entry-extract-pdf sync0-bibtex-entry-key beg end))
        (sync0-bibtex-entry-extract-pdf sync0-bibtex-entry-key)))
    (sync0-bibtex-entry-append-to-bibliography sync0-bibtex-entry-key)
    (sync0-bibtex-entry-create-obsidian-note-from-entry sync0-bibtex-entry-key)
    ;; Reset these two values to prevent unwanted extractions
    (setq sync0-bibtex-entry-extract nil
          sync0-bibtex-entry-crossref-entry nil
          sync0-bibtex-entry-use-extraction-page-numbers nil)
    ;; Insert entry in default bibliography file
    (sync0-bibtex-update-vars sync0-bibtex-variables-list)))

;; (defun sync0-bibtex-pick-crossref ()
;;   "Use bibtex-completion to pick a crossref bibtex key."
;;   (interactive)
;;   (let* ((candidates (bibtex-completion-candidates))
;;          (selection (ivy-read "Crossref : "
;;                               candidates
;;                               :caller 'ivy-bibtex
;;                               :history 'ivy-bibtex-history)))
;;     (cdr (assoc "=key=" (cdr (assoc selection candidates))))))

;; (defun sync0-bibtex-update-authors-list ()
;;   "Update the contents of file bibtex-authors.txt from the date in
;; our main bibliography file"
;;   (interactive)
;;   (let ((current-authors)
;;         (final-list)
;;         (bibtex-authors  (delete-duplicates
;;                           (append
;;                            (mapcar #'(lambda (x) (cdr (assoc "editor" x)))
;;                                      (bibtex-completion-candidates))
;;                            (mapcar #'(lambda (x) (cdr (assoc "author" x)))
;;                                      (bibtex-completion-candidates))))))
;;     (with-temp-buffer
;;       (insert-file-contents "~/.emacs.d/sync0-vars/bibtex-authors.txt")
;;       (goto-char (point-min))
;;       ;; (keep-lines "contexts" (point-min) (point-max)) 
;;       (while (re-search-forward "^\\([[:print:]]+\\)\n" (point-max) t)
;;         (push  (match-string 1) current-authors)))
;;     (with-temp-file
;;         "~/.emacs.d/sync0-vars/bibtex-authors.txt"
;;       (setq final-list (delete-dups (append current-authors bibtex-authors)))
;;       (sync0-insert-elements-of-list final-list))))

;; (defun sync0-bibtex-update-booktitles-list ()
;;   "Update the contents of file bibtex-authors.txt from the date in
;; our main bibliography file"
;;   (interactive)
;;   (let ((current-authors)
;;         (final-list)
;;         (bibtex-authors  (delete-duplicates 
;;                           (mapcar #'(lambda (x) (cdr (assoc "booktitle" x)))
;;                                     (bibtex-completion-candidates)))))
;;     (with-temp-buffer
;;       (insert-file-contents "~/.emacs.d/sync0-vars/bibtex-booktitles.txt")
;;       (goto-char (point-min))
;;       ;; (keep-lines "contexts" (point-min) (point-max)) 
;;       (while (re-search-forward "^\\([[:print:]]+\\)\n" (point-max) t)
;;         (push  (match-string 1) current-authors)))
;;     (with-temp-file
;;         "~/.emacs.d/sync0-vars/bibtex-booktitles.txt"
;;       (setq final-list (delete-dups (append current-authors bibtex-authors)))
;;       (sync0-insert-elements-of-list final-list))))

;; (defun sync0-bibtex-update-locations-list ()
;;   "Update the contents of file bibtex-authors.txt from the date in
;; our main bibliography file"
;;   (interactive)
;;   (let ((current-authors)
;;         (final-list)
;;         (bibtex-authors  (delete-duplicates 
;;                           (mapcar #'(lambda (x) (cdr (assoc "location" x)))
;;                                     (bibtex-completion-candidates)))))
;;     (with-temp-buffer
;;       (insert-file-contents "~/.emacs.d/sync0-vars/bibtex-locations.txt")
;;       (goto-char (point-min))
;;       ;; (keep-lines "contexts" (point-min) (point-max)) 
;;       (while (re-search-forward "^\\([[:print:]]+\\)\n" (point-max) t)
;;         (push  (match-string 1) current-authors)))
;;     (with-temp-file
;;         "~/.emacs.d/sync0-vars/bibtex-locations.txt"
;;       (setq final-list (delete-dups (append current-authors bibtex-authors)))
;;       (sync0-insert-elements-of-list final-list))))

;; (defun sync0-bibtex-update-traces-list ()
;;   "Update the contents of file bibtex-authors.txt from the date in
;; our main bibliography file"
;;   (interactive)
;;   (let ((current-authors)
;;         (final-list)
;;         (bibtex-authors  (delete-duplicates 
;;                           (mapcar #'(lambda (x) (cdr (assoc "library" x)))
;;                                     (bibtex-completion-candidates)))))
;;     (with-temp-buffer
;;       (insert-file-contents "~/.emacs.d/sync0-vars/bibtex-trace.txt")
;;       (goto-char (point-min))
;;       ;; (keep-lines "contexts" (point-min) (point-max)) 
;;       (while (re-search-forward "^\\([[:print:]]+\\)\n" (point-max) t)
;;         (push  (match-string 1) current-authors)))
;;     (with-temp-file
;;         "~/.emacs.d/sync0-vars/bibtex-trace.txt"
;;       (setq final-list (delete-dups (append current-authors bibtex-authors)))
;;       (sync0-insert-elements-of-list final-list))))

;; (defun sync0-bibtex-update-media-list ()
;;   "Update the contents of file bibtex-authors.txt from the date in
;; our main bibliography file"
;;   (interactive)
;;   (let ((current-authors)
;;         (final-list)
;;         (bibtex-authors  (delete-duplicates 
;;                           (mapcar #'(lambda (x) (cdr (assoc "medium" x)))
;;                                     (bibtex-completion-candidates)))))
;;     (with-temp-buffer
;;       (insert-file-contents "~/.emacs.d/sync0-vars/bibtex-media.txt")
;;       (goto-char (point-min))
;;       ;; (keep-lines "contexts" (point-min) (point-max)) 
;;       (while (re-search-forward "^\\([[:print:]]+\\)\n" (point-max) t)
;;         (push  (match-string 1) current-authors)))
;;     (with-temp-file
;;         "~/.emacs.d/sync0-vars/bibtex-media.txt"
;;       (setq final-list (delete-dups (append current-authors bibtex-authors)))
;;       (sync0-insert-elements-of-list final-list))))

;; (defun sync0-bibtex-update-publishers-list ()
;;   "Update the contents of file bibtex-authors.txt from the date in
;; our main bibliography file"
;;   (interactive)
;;   (let ((current-authors)
;;         (final-list)
;;         (bibtex-authors  (delete-duplicates 
;;                           (mapcar #'(lambda (x) (cdr (assoc "publisher" x)))
;;                                     (bibtex-completion-candidates)))))
;;     (with-temp-buffer
;;       (insert-file-contents "~/.emacs.d/sync0-vars/bibtex-publishers.txt")
;;       (goto-char (point-min))
;;       ;; (keep-lines "contexts" (point-min) (point-max)) 
;;       (while (re-search-forward "^\\([[:print:]]+\\)\n" (point-max) t)
;;         (push  (match-string 1) current-authors)))
;;     (with-temp-file
;;         "~/.emacs.d/sync0-vars/bibtex-publishers.txt"
;;       (setq final-list (delete-dups (append current-authors bibtex-authors)))
;;       (sync0-insert-elements-of-list final-list))))

;; (defun sync0-bibtex-update-journals-list ()
;;   "Update the contents of file bibtex-authors.txt from the date in
;; our main bibliography file"
;;   (interactive)
;;   (let ((current-authors)
;;         (final-list)
;;         (bibtex-authors  (delete-duplicates 
;;                           (mapcar #'(lambda (x) (cdr (assoc "journaltitle" x)))
;;                                     (bibtex-completion-candidates)))))
;;     (with-temp-buffer
;;       (insert-file-contents "~/.emacs.d/sync0-vars/bibtex-journals.txt")
;;       (goto-char (point-min))
;;       ;; (keep-lines "contexts" (point-min) (point-max)) 
;;       (while (re-search-forward "^\\([[:print:]]+\\)\n" (point-max) t)
;;         (push  (match-string 1) current-authors)))
;;     (with-temp-file
;;         "~/.emacs.d/sync0-vars/bibtex-journals.txt"
;;       (setq final-list (delete-dups (append current-authors bibtex-authors)))
;;       (sync0-insert-elements-of-list final-list))))

;; (defun sync0-bibtex-update-sync0-variables ()
;;   "Update the helper bibtex variables from the content in the
;; bibliography file."
;;   (interactive)
;;   (progn 
;;     (sync0-bibtex-update-authors-list)
;;     (sync0-bibtex-update-booktitles-list)
;;     (sync0-bibtex-update-locations-list)
;;     (sync0-bibtex-update-media-list)
;;     (sync0-bibtex-update-traces-list)
;;     (sync0-bibtex-update-publishers-list)
;;     (sync0-set-variable-from-files sync0-bibtex-variables-list)))

;; (defun sync0-bibtex-new-key ()
;;   "Change bibtex key at point with a key using the format provided
;; by org-roam files"
;;   (interactive)
;;   (let* ((new (yes-or-no-p "Use existing key for new entry? "))
;;          (new-key (if new
;;                       (read-string "Input existing key: ")
;;                     (format-time-string "%Y%m%d%H%M%S"))))
;;     (setq sync0-bibtex-new-key new-key)
;;     (insert new-key)))

;; (defun sync0-bibtex-create-key ()
;;   "Change bibtex key at point with a key using the format provided
;; by org-roam files"
;;   (interactive)
;;   (let* ((new-key (format-time-string "%Y%m%d%H%M%S")))
;;     (insert new-key)))

(defun sync0-bibtex-next-key ()
  "Print the bibtex key of the document"
  (interactive)
  (let ((bibtex-key (re-search-forward "@.+{" nil nil 1)))
    (goto-char bibtex-key)))

(defun sync0-bibtex-previous-key ()
  "Print the bibtex key of the document"
  (interactive)
  (let ((bibtex-key (re-search-backward "@.+{" nil nil 2)))
    (goto-char bibtex-key)
    (re-search-forward "@.+{" nil nil 1)))

(defun sync0-bibtex-update-key ()
  "Change bibtex key at point with a key using the format provided
by org-roam files"
  (interactive)
  (let* ((new-key (format-time-string "%Y%m%d%H%M%S"))
         (directory "/home/sync0/Documents/pdfs/")
         (new-path (concat directory new-key ".pdf"))
         (regex "^@\\([[A-z]+\\){[[:alnum:]]+,")
         (beg
          (save-excursion
            (re-search-forward regex nil t 1)))
         (end
          (save-excursion
            (re-search-forward "^}\n" nil t 1)))
         (type
          (save-excursion
            (re-search-forward regex end t 1)
            (match-string-no-properties 1)))
         (path-string
          (concat "file = {" new-path "},\n"))
         (type-string
          (concat "@" type "{" new-key ",\n")))
    (re-search-forward regex end t 1) 
    (kill-whole-line 1)
    (insert type-string)
    (if (re-search-forward "file[[:blank:]]+=[[:blank:]]+{" end t 1)
        (progn 
          (kill-whole-line 1)
          (insert path-string))
      (unless (string= type "Online")
        (next-line)
        (insert path-string)))))

(defun sync0-bibtex-clean-entry ()
  "Change bibtex key at point with a key using the format provided
by org-roam files"
  (interactive)
  (let* ((new-key (format-time-string "%Y%m%d%H%M%S"))
         (directory "/home/sync0/Documents/pdfs/")
         (new-path (concat directory new-key ".pdf"))
         (regex "^@\\([[A-z]+\\){[[:alnum:]]+,")
         (beg
          (save-excursion
            (re-search-forward regex nil t 1)))
         (end
          (save-excursion
            (re-search-forward "^}\n" nil t 1)))
         (type
          (save-excursion
            (re-search-forward regex end t 1)
            (match-string-no-properties 1)))
         (language (completing-read "Choose language : "
                                    sync0-bibtex-completion-language))
         (language-string
          (concat "  language          = {"
                  language
                  "},\n  langid          = {"
                  language
                  "},\n" 
                  ))
         (type-string
          (concat "@" (upcase-initials type) "{" new-key ",\n")))
    (re-search-forward regex end t 1) 
    (kill-whole-line 1)
    (insert type-string)
    (save-excursion
      (when (re-search-forward "\\(journal\\)[[:blank:]]+=" end t 1)
        (replace-match "journaltitle" nil nil nil 1)))
    (save-excursion
      (when (re-search-forward "\\(year\\)[[:blank:]]+=" end t 1)
        (replace-match "date" nil nil nil 1)))
    (next-line)
    (insert language-string)))

(defun sync0-bibtex-create-md-note-from-entry ()
  (interactive)
  (mapcar #'(lambda (a) (set a nil)) sync0-bibtex-entry-definitions)
  (let*    ((rawbibkey (when (re-search-forward "^@[A-z]+{\\([[:digit:]]+\\)," nil t 1)
                         (match-string-no-properties 1)))
            (bibkey (read-string "Input bibkey to create notes for : " rawbibkey))
            (entry (bibtex-completion-get-entry bibkey))
            (type (bibtex-completion-get-value "=type=" entry)))
    (setq sync0-bibtex-entry-creation-entry entry)
    (setq sync0-bibtex-entry-crossref 
             (bibtex-completion-get-value "crossref" entry))
    (setq sync0-bibtex-entry-crossref-entry
          (when sync0-bibtex-entry-crossref
            (bibtex-completion-get-entry sync0-bibtex-entry-crossref)))
    (setq sync0-bibtex-entry-initial-date nil
          sync0-bibtex-entry-initial-origdate nil
          sync0-bibtex-entry-initial-author nil
          sync0-bibtex-entry-initial-language nil)
    ;; General settings
    (setq sync0-bibtex-entry-type type)
    (setq sync0-bibtex-entry-type-downcase
          (downcase type))
    (setq sync0-bibtex-entry-key bibkey)
    (sync0-bibtex-entry-define-author sync0-bibtex-entry-key)
    (sync0-bibtex-entry-define-title sync0-bibtex-entry-key)
    (sync0-bibtex-entry-define-date sync0-bibtex-entry-key)
    (sync0-bibtex-entry-define-language sync0-bibtex-entry-key)
    ;; (sync0-bibtex-entry-define-keywords)
    ;; Specific settings
    (setq sync0-bibtex-entry-parent
          (cond ((string= type "Article")
                 (bibtex-completion-get-value "journaltitle" entry))
                ((or (string= type "InBook")
                     (string= type "InCollection")
                     (string= type "InProceedings"))
                 (sync0-bibtex-entry-define-booktitle)
                 (if (sync0-null-p sync0-bibtex-entry-booksubtitle)
                     sync0-bibtex-entry-booktitle
                   (concat sync0-bibtex-entry-booktitle " : " sync0-bibtex-entry-booksubtitle)))
                (t (bibtex-completion-get-value "series" entry))))
    (setq sync0-bibtex-entry-pages
          (bibtex-completion-get-value "pages" sync0-bibtex-entry-creation-entry))
    (unless (sync0-null-p sync0-bibtex-entry-pages)
      (setq sync0-bibtex-entry-extract
            (yes-or-no-p "Extract  PDF from existing entry?"))
      (setq sync0-bibtex-entry-use-extraction-page-numbers
            (when sync0-bibtex-entry-extract
              (yes-or-no-p "Use page numbers from extraction?")))
      (if sync0-bibtex-entry-use-extraction-page-numbers
          (let ((beg (progn
                       (string-match "\\([[:digit:]]+\\)-[[:digit:]]+"  sync0-bibtex-entry-pages)
                       (match-string 1 sync0-bibtex-entry-pages)))
                (end (progn
                       (string-match "[[:digit:]]+-\\([[:digit:]]+\\)" sync0-bibtex-entry-pages)
                       (match-string 1 sync0-bibtex-entry-pages))))
            (sync0-bibtex-entry-extract-pdf sync0-bibtex-entry-key beg end))
        (sync0-bibtex-entry-extract-pdf sync0-bibtex-entry-key)))
    (sync0-bibtex-entry-create-obsidian-note-from-entry sync0-bibtex-entry-key)
    ;; Reset these two values to prevent unwanted extractions
    (setq sync0-bibtex-entry-extract nil
          sync0-bibtex-entry-crossref-entry nil
          sync0-bibtex-entry-creation-entry nil
          sync0-bibtex-entry-use-extraction-page-numbers nil)))

;; (when (file-exists-p pdf-path)
;;   (rename-file pdf-path new-path)))))

(defun sync0-bibtex-extract-multiple-entries-from-pdf (seqlists)
  "Extract pdfs and create bibtex entries and markdown entries
for each extranction. This function requires an input 'seqlists'
that is a list composed of n lists of the form: (name,
first-page, last-page). Likewise, for this to work, it is
necessary that the pages of the pdf match the page numbers of the
actual book. Otherwise, the entries will have wrong data."
  (let* ((bibkey (sync0-bibtex-completion-choose-key))
         (entry (bibtex-completion-get-entry bibkey))
         (input-file (car (bibtex-completion-find-pdf bibkey)))
         (obsidian-master-note (concat sync0-obsidian-directory bibkey ".md"))
         (type (completing-read "Choose Bibtex entry type: " sync0-bibtex-entry-types))
         (type-downcase (downcase type))
         (creation (format-time-string "%Y-%m-%d")) 
         (parent (bibtex-completion-get-value "title" entry))
         (origdate (bibtex-completion-get-value "origdate" entry))
         (date (bibtex-completion-get-value "date" entry))
         (date-fixed (cond ((and (null date)
                                 (null origdate)) "")
                           ((null origdate)
                            (concat "(" date ")"))
                           (t (concat "(" origdate ") (" date ")"))))
         (date-tag
          (replace-regexp-in-string "-" "/" date))
         (author (completing-read "Auteur : " sync0-bibtex-completion-author
                                  nil nil nil))
         (author-fixed (unless (string= author "nil")
                         (cond ((string-match " and " author)
                                ;; create a list with parts 
                                (let* ((author-list  (split-string author " and "))
                                       (names (let (x)
                                                (dolist  (element author-list x)
                                                  (setq x (concat x element "\", \""))))))
                                  (concat "\"" (substring names 0 -2))))
                               ;; check when author is an organization
                               ((string-match "^{" author)
                                (concat "\"" (substring author 1 -1) "\""))
                               ;; other cases
                               (t (concat "\"" author "\"")))))
         (lastname (cond ((string-match " and " author)
                          ;; create a list with parts 
                          (let* ((author-list  (split-string author " and "))
                                 (last-names (let (x)
                                               (dolist  (element author-list x)
                                                 (setq x (concat x
                                                                 (progn
                                                                   (string-match "\\([[:graph:]]+\\),"   element)
                                                                   (match-string 1 element))
                                                                 ", "))))))
                            (substring last-names 0 -2)))
                         ((string-match "^{" author)
                          (string-match "{\\([[:print:]]+\\)}" author)
                          (match-string 1 author))
                         (t (nth 0 (split-string author ", ")))))
         (lastname-raw (cond ((string-match " and " author)
                              ;; create a list with parts 
                              (let* ((author-list  (split-string author " and "))
                                     (last-names (let (x)
                                                   (dolist  (element author-list x)
                                                     (setq x (concat x
                                                                     (progn
                                                                       (string-match "\\([[:graph:]]+\\),"   element)
                                                                       (match-string 1 element))
                                                                     ", author/"))))))
                                ;; (substring last-names 0 -2)))
                                (substring last-names 0 -7)))
                             ((string-match "^{" author)
                              (string-match "{\\([[:print:]]+\\)}" author)
                              (match-string 1 author))
                             (t (nth 0 (split-string author ", ")))))
         (author-tag-obsidian
          (replace-regexp-in-string "[[:space:]]+" "_" (downcase lastname-raw)))
         (language (bibtex-completion-get-value "language" entry))
         (langid language)
         (crossref bibkey)) 


    ;; End of definition before loop
    ;; Loop for extracting the pdf using ghostcritp
    (dolist (elt seqlists)
      (let* ((raw-filename (1+ (string-to-number (format-time-string "%Y%m%d%H%M%S"))))
             (filename (number-to-string raw-filename))
             (file-pdf (concat "/home/sync0/Documents/pdfs/" filename ".pdf"))
             (title (nth 0 elt))
             (beg (number-to-string (nth 1 elt)))
             (end (number-to-string (nth 2 elt)))
             (pages (concat beg "-" end))
             (bibtex-definitions (list 
                                  title
                                  date
                                  author
                                  crossref
                                  pages
                                  language
                                  langid
                                  file-pdf))
             (bibtex-fields sync0-bibtex-extract-fields)
             (fields (mapcar* #'(lambda (x y) (list x y)) bibtex-fields bibtex-definitions))
             ;; define the bibtex entries
             (entries
              (let (x)
                (dolist (element fields x) 
                  (unless (or (null (cadr element))
                              (string= (cadr element) ""))
                    (setq x (concat x (car element) " = {" (cadr element) "},\n"))))))
             (bib-file sync0-default-bibliography) 
             ;; create string of new bibtex entry
             (obsidian-file (concat sync0-obsidian-directory filename ".md")) 
             (obsidian-entry (concat "---\n"
                                     "id: " filename "\n"
                                     "citekey: " filename "\n"
                                     "zettel_type: reference\n"
                                     "biblatex_type: " type-downcase "\n"
                                     "title: \"" title "\"\n"
                                     "created: " creation "\n"
                                     "crossref: " crossref "\n"
                                     "parent: \"" parent "\"\n"
                                     (unless (string= author "nil")
                                       (concat "author: [" author-fixed "]\n"))
                                     "aliases: [\"" (unless (string= author "nil") (concat lastname " "))  date-fixed  " " title "\"]\n"
                                     (unless (or (null origdate)
                                                 (string= origdate ""))
                                       (concat "origdate: " origdate "\n"))
                                     "date: " date "\n"
                                     "language: " language "\n"
                                     "tags: [reference/" type-downcase ", bibkey/" filename ", date/" date-tag (unless (string= author "nil") (concat ", author/" author-tag-obsidian)) ", language/" language "]\n"
                                     "---\n" 
                                     "# " (unless (string= author "nil") (concat lastname " "))  date-fixed " " title "\n\n" 
                                     "## Description\n\n" 
                                     "## Progrès de la lecture\n\n" 
                                     "## Annotations\n\n"))
             (bibtex-entry (concat "@" type "{" filename "," "\n" entries "}\n"))
             (obsidian-reference (concat "\n- [" lastname " " date-fixed " " title "](" filename ".md)\n"))
             (extraction-command (concat
                                  "gs -sDEVICE=pdfwrite -dNOPAUSE -dBATCH -dSAFER -dFirstPage="
                                  beg
                                  " -dLastPage="
                                  end
                                  " -sOutputFile="
                                  sync0-pdfs-folder
                                  filename
                                  ".pdf "
                                  input-file)))
        ;; End of definitions for sublist
        ;; Append new bibtex entry to default bibliography file
        (with-temp-buffer 
          (insert obsidian-reference)
          (append-to-file (point-min) (point-max) obsidian-master-note))
        (with-temp-buffer 
          (insert bibtex-entry)
          (append-to-file (point-min) (point-max) bib-file))
        ;; Create md note in obsidian based on the defined metadata
        (with-temp-buffer 
          (insert obsidian-entry)
          (write-file obsidian-file))
        ;; Extract the pdf
        (shell-command extraction-command)))))

(major-mode-hydra-define bibtex-mode nil 
  ("References"
   (("c" sync0-bibtex-clean-entry "Clean entry")
    ("E" sync0-bibtex-define-entry "Capture entry")
    ("e" (sync0-bibtex-define-entry t) "Quick capture")
    ("u" sync0-bibtex-update-key "Update next key")
    ("N" sync0-bibtex-create-md-note-from-entry "Create md from entry"))
   "PDFs"
   (("p" sync0-org-ref-copy-pdf-to-path "Copy to path")
    ("s" sync0-pdf-page-extractor "Extract from entry")
    ("o" sync0-org-ref-open-pdf-at-point "Open in pdfview")
    ("z" sync0-org-ref-open-pdf-at-point-zathura "Open in zathura"))
   "Annotations"
   (("n" sync0-ivy-bibtex-open-notes "Open annotations"))
   "Bibliographies"
   (("v" ivy-bibtex "Visit entry")
    ("r" (sync0-bibtex-update-completion-files sync0-bibtex-variables-list) "Refresh completion vars")
    ("V" sync0-visit-bibliography-in-buffer "Visit bibfile"))))

(provide 'sync0-bibtex-functions)
